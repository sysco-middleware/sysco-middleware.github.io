I"‹G<h1 id="introduction">Introduction</h1>

<p>In this very short post we are going to create a simple pipeline for getting data from Oslo City Bike public API service
using Sesam.io integration platform with 5-10 minutes of our time.   We donâ€™t need so much time here because itâ€™s easy
to make integrations with Sesam. You donâ€™t need to write programs or deal with infrastructure to deploy them.<br />
Data we are going to collect will provide us bike availability at different stations over time.</p>

<p>Oslo city bike is a simplest way to explore Oslo by using public bicycle. There are more than 200 bike stations in Oslo
and more than 50 000 users of this service.</p>

<p>Sesam.io is a integration platform delivered as PAAS. It is optimised for collecting or receiving data from 
source systems, transforming data, and providing data for target systems.</p>

<h1 id="lets-begin">Letâ€™s begin</h1>
<p>First of all we need to create Sesam user account <a href="https://portal.sesam.io">here</a> and join â€œOpen Sesamâ€ subscription which is free of charge.</p>

<p><img src="/images/2019-02-21-Making-data-pipelines-with-Sesam-and-Oslo-City-Bike-public-API-in-5-minutes/02_sesam_studio.png" alt="" /></p>

<p>So we need a second one account, this time for <a href="https://developer.oslobysykkel.no">Oslo City Bike service</a> and we need to <br />
create new API client. This procedure is very easy and we will get API key needed for making API requests.</p>

<p><img src="/images/2019-02-21-Making-data-pipelines-with-Sesam-and-Oslo-City-Bike-public-API-in-5-minutes/01_osb_client.png" alt="" /></p>

<p>After we completed two preparation steps we can start to do something useful.</p>

<p>Sesam operates with definitions â€œSystemsâ€ and â€œPipesâ€ where System may be any data source or data sink such as databases, REST APIâ€™s, cloud services, files on network shares, etc. 
A pipe represents a data flow from source to sink and specifies 
how data entities transformed, enriched or filtered on their way.</p>

<p>Letâ€™s create our first system that will represent Oslo City Bike API.<br />
In Sesam management studio dashboard click on â€œSystemsâ€ menu and then â€œNew systemâ€ button.
System definition is a JSON object where we need to provide free-chosen id, type - system:url, add authentication headers<br />
which will be sent with every request and assign URL pattern for API. Thatâ€™s all.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oslo-bysikkel"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:url"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Client-Identifier"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$SECRET(access-token)"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"url_pattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://oslobysykkel.no/api/v1/%s"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"verify_ssl"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Press save to store new system. You may see that Client-Identifier header which obviously used to send Oslo City Bike API key
contains strange value starting with â€˜$SECRETâ€™. 
It means Sesam will try to find â€˜access-tokenâ€™ attribute in Sesam vault.
Sesam vault is write only encrypted storage for sensitive data like application credentials. We are going now to add our
API key for Oslo City Bike API to this vault. Simply click on â€œSecretsâ€ tab and â€œAdd secretâ€ button after that.<br />
<img src="/images/2019-02-21-Making-data-pipelines-with-Sesam-and-Oslo-City-Bike-public-API-in-5-minutes/03_sesam_studio.png" alt="" /><br />
Assign name â€œaccess-tokenâ€ and paste your Oslo City Bike API key into value field. Press â€œAddâ€. Thatâ€™s all, now your key
is securely stored in Sesam vault. 
After creating data source system we need to create some pipes which will fetch data from that system. In Sesam dashboard click on â€œPipesâ€ menu and then â€œNew Pipeâ€ button.</p>

<p>Pipe configuration is also simple JSON object which has 4 main components:</p>
<ul>
  <li>Source - which system is our data source</li>
  <li>Transform - which transformations will be applied to every data entity flowing through this pipe</li>
  <li>Sink - target system, if omitted then pipe will produce a data set with the same name as pipe id</li>
  <li>Pump - contains â€œpumpingâ€ options such as pipe schedule, dead letter queue options, etc</li>
</ul>

<p>Our first pipe will fetch data from â€œ/stationsâ€ Oslo City Bike API endpoint that provides data for all stations currently in operation.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oslo-bysikkel-stations"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pipe"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oslo-bysikkel"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/stations"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"transform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dtl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rules"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">[</span><span class="s2">"create"</span><span class="p">,</span><span class="w">
          </span><span class="p">[</span><span class="s2">"apply"</span><span class="p">,</span><span class="w"> </span><span class="s2">"add-id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_S.stations"</span><span class="p">]</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"add-id"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_id"</span><span class="p">,</span><span class="w">
          </span><span class="p">[</span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_S.id"</span><span class="p">]</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="p">[</span><span class="s2">"copy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"*"</span><span class="p">]</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"pump"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"cron_expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0 0 1 * ?"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Here we use our previously created system as source of data, schedule pipe to run monthly (stations are quite static and
we donâ€™t expect many changes here) and apply some cryptic transformation that is needed to be explained.<br />
Sesam pipe expect to get an array of data entities on its input while Oslo City Bike API returns a JSON object. So we need
to use built in <a href="https://docs.sesam.io/DTLReferenceGuide.html">Data Transformation Language</a> (or simply DTL) to transform input object into array of stations and emit every station object as own entity. Second thing we do here is â€œidâ€ assign.<br />
Every entity in Sesam must have an string attribute named â€œ_idâ€ - entity key. Itâ€™s used for entity identification, compaction, etc.
Thatâ€™s all, press â€œSaveâ€ and then â€œStartâ€ buttons. After a second a new data set will be populated with stations data.</p>

<p>Now letâ€™s create a second pipe which will fetch information about station availability at current time. Pipe setup is almost the same and we can simply duplicate our first pipe by clicking respective link in pipe options.</p>

<p><img src="/images/2019-02-21-Making-data-pipelines-with-Sesam-and-Oslo-City-Bike-public-API-in-5-minutes/04_sesam_studio.png" alt="" /></p>

<p>Now, letâ€™s do some changes.</p>
<ul>
  <li>Change pipe id to desired</li>
  <li>Change source URL to â€œ/stations/availabilityâ€ endpoint</li>
  <li>In transformation section add â€œupdated_atâ€ timestamp from input data root to every entity</li>
  <li>Add timestamp to entity id to unique identify every station and time point we collect.</li>
  <li>Add station name from our first data set by performing join operation (DTL function â€œhopsâ€)</li>
  <li>Change pipe pump schedule to fixed interval (900 seconds or 15 minutes in our example)</li>
  <li>Add explicit sink section with attribute â€œdeletion_trackingâ€ equal to false</li>
</ul>

<p>We need deletion_tracking disabled because by default full data set synchronization will delete previous entities.
Sesam, however, has functionality for incremental data sync as well as for full sync.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oslo-bysikkel-availability"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pipe"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oslo-bysikkel"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/stations/availability"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"sink"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"dataset"</span><span class="p">:</span><span class="w"> </span><span class="s2">"oslo-bysikkel-availability"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"deletion_tracking"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"transform"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dtl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rules"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">[</span><span class="s2">"create"</span><span class="p">,</span><span class="w">
          </span><span class="p">[</span><span class="s2">"apply"</span><span class="p">,</span><span class="w"> </span><span class="s2">"add-id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_S.stations"</span><span class="p">]</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"add-id"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_id"</span><span class="p">,</span><span class="w">
          </span><span class="p">[</span><span class="s2">"concat"</span><span class="p">,</span><span class="w">
            </span><span class="p">[</span><span class="s2">"string"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_S.id"</span><span class="p">],</span><span class="w"> </span><span class="s2">"-"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_P._S.updated_at"</span><span class="p">]</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="p">[</span><span class="s2">"copy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"*"</span><span class="p">],</span><span class="w">
        </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="s2">"updated_at"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_P._S.updated_at"</span><span class="p">]</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dtl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rules"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">[</span><span class="s2">"copy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"*"</span><span class="p">],</span><span class="w">
        </span><span class="p">[</span><span class="s2">"add"</span><span class="p">,</span><span class="w"> </span><span class="s2">"title"</span><span class="p">,</span><span class="w">
          </span><span class="p">[</span><span class="s2">"first"</span><span class="p">,</span><span class="w">
            </span><span class="p">[</span><span class="s2">"hops"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"datasets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"oslo-bysikkel-stations t1"</span><span class="p">],</span><span class="w">
              </span><span class="nl">"where"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">[</span><span class="s2">"eq"</span><span class="p">,</span><span class="w"> </span><span class="s2">"_S.id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"t1.id"</span><span class="p">]</span><span class="w">
              </span><span class="p">],</span><span class="w">
              </span><span class="nl">"return"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t1.title"</span><span class="w">
            </span><span class="p">}]</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}],</span><span class="w">
  </span><span class="nl">"pump"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"schedule_interval"</span><span class="p">:</span><span class="w"> </span><span class="mi">900</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Press â€œSaveâ€ and â€œStartâ€ buttons.</p>

<p>Now station availability data will be fetched and stored in Sesam every 15 minutes.</p>

<p>Thatâ€™s all, right now bicycle season is closed due to winter, but will be opened from 1 March. We will collect some data
enough for availability analysis, but this will be topic for next post.</p>
:ET